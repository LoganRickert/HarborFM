# Harbor FM reverse proxy. Accept any hostname (on-demand TLS).
# Caddy obtains and renews TLS automatically per hostname; no certbot needed.

{
	# Access log to file for fail2ban (caddy-scanner jail)
	log {
		output file /var/log/caddy/access.log
		format json
	}
}

# Accept any hostname: cert is obtained on first request (on_demand).
:443 {
	tls {
		on_demand
	}

	# Health check for container/orchestration
	respond /caddy-health 200

	@auth path /api/auth/login /api/auth/register /api/auth/forgot-password /api/auth/reset-password /api/auth/verify-email /api/auth/validate-reset-token
	handle @auth {
		reverse_proxy harborfm:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			transport http {
				read_timeout 600s
				write_timeout 600s
			}
		}
	}

	handle {
		reverse_proxy harborfm:3001 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
			transport http {
				read_timeout 600s
				write_timeout 600s
			}
		}
	}
}
